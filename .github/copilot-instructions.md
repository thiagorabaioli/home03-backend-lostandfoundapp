<!-- Autogenerated: guidance for AI coding agents working on this repo -->
# Copilot instructions for LostAndFoundAPP

This file contains concise, repo-specific guidance for AI coding agents to be productive quickly.

- Project type: Spring Boot (Java 21) monolithic backend combining an OAuth2 Authorization Server and a Resource Server (same process).
- Build: Maven (wrapper included). Primary commands: `./mvnw clean package`, `./mvnw spring-boot:run`, `./mvnw test`.

Important files & locations

- Security & auth: `src/main/java/tfr/LostAndFoundAPP/config/`
  - `AuthorizationServerConfig.java` — in-memory RegisteredClient, custom password grant, token generator (JWT with in-memory RSA JWK).
  - `ResourceServerConfig.java` — resource server JWT setup, CORS config, H2 console security for `test` profile.
  - `GoogleSecurityConfig.java` — OAuth2 login filter for `/oauth2/authorization/**` and `/login/oauth2/code/**` with `defaultSuccessUrl` set to `https://app.sias.world` (update when testing locally).

- Domain: `src/main/java/tfr/LostAndFoundAPP/entities/`, `repositories/`, `services/`, `controllers/` — typical Spring layering (entities → repositories → services → controllers).

- Config & data: `src/main/resources/` contains `application.properties` (controls active profile), `application-dev.properties` (Postgres), `application-test.properties` (H2), and `import.sql` (seed data).

Key repo patterns and conventions

- Profiles: `dev` uses PostgreSQL (edit `application-dev.properties`); `test` uses H2 (default in `application.properties`). Switch profiles with `SPRING_PROFILES_ACTIVE` or by editing `application.properties`.
- OAuth2: the app exposes authorization endpoints under `/oauth2/**` and `.well-known/**`. The Authorization Server registers a custom `password` grant via classes in `config/customgrant/` — prefer reviewing that package before touching token logic.
- CORS: configured centrally in `ResourceServerConfig.corsConfigurationSource()` and driven by the `cors.origins` property (`CORS_ORIGINS` env var). By default `*` in `application.properties` for convenience.
- H2 console: enabled and unprotected only under the `test` profile (`PathRequest.toH2Console()` matcher).
- Mail: configured via Spring Mail; environment variables `MAIL_USERNAME` and `MAIL_PASSWORD` must be set for email functionality.

Developer workflows & examples

- Run locally with dev profile (Postgres):
  - export or set `CLIENT_ID`, `CLIENT_SECRET`, `MAIL_USERNAME`, `MAIL_PASSWORD`, and `CORS_ORIGINS`.
  - update `src/main/resources/application-dev.properties` with your Postgres URL/credentials.
  - Start: `./mvnw spring-boot:run` (or `./mvnw clean package && java -jar target/*.jar`).

- Run tests (H2 in-memory):
  - `./mvnw test` (the project defaults to `test` profile via `application.properties`).

- Obtain an access token (custom password grant):
  - Example (basic auth with client creds):
    ```bash
    curl -u myclientid:myclientsecret \
      -d 'grant_type=password&username=USER&password=PASS' \
      -X POST http://localhost:8080/oauth2/token
    ```
  - The exact request/response format is controlled by `config/customgrant/*` — inspect there if tokens fail.

Integration notes & gotchas

- The Authorization Server and Resource Server run in the same JVM. Token signing is done with an in-memory RSA keypair (see `AuthorizationServerConfig.jwkSource()`): tokens are ephemeral across restarts. For production, replace with persistent JWK source or external keystore.
- `GoogleSecurityConfig` redirects OAuth2 logins to `https://app.sias.world` by default. Change `defaultSuccessUrl` for local dev/testing.
- `ResourceServerConfig` currently sets `authorize.anyRequest().permitAll()` for the main chain — validate intent before restricting endpoints; test profile H2 console has its own filter chain.

Files to inspect first for most changes

- `AuthorizationServerConfig.java`, `ResourceServerConfig.java`, `GoogleSecurityConfig.java`
- `src/main/java/tfr/LostAndFoundAPP/config/customgrant/` (custom grant implementation)
- `src/main/java/tfr/LostAndFoundAPP/controllers/` (HTTP API surface)
- `src/main/resources/application-*.properties` (profile-specific behavior)

When editing code

- Preserve existing security filter chain order annotations (`@Order`) — changing order can easily break auth flows.
- If touching token generation, run integration flows: token request + JWT decode using the app's JWK endpoint (/.well-known/jwks.json).
- Keep DB migrations / seeds in sync with `import.sql` when modifying entities used by initial data.

If something is unclear or you want this tightened to a specific task (tests, adding endpoints, changing auth), tell me which area and I'll update this guidance.
